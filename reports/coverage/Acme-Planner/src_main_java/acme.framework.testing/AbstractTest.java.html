<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../jacoco-resources/report.gif" type="image/gif"/><title>AbstractTest.java</title><link rel="stylesheet" href="../../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">Acme-Planner (Run) (2 Jun 2021 12:07:42)</a> &gt; <a href="../../index.html" class="el_group">Acme-Planner</a> &gt; <a href="../index.html" class="el_bundle">src/main/java</a> &gt; <a href="index.source.html" class="el_package">acme.framework.testing</a> &gt; <span class="el_source">AbstractTest.java</span></div><h1>AbstractTest.java</h1><pre class="source lang-java linenums">/*
 * AbstractTest.java
 *
 * Copyright (C) 2012-2021 Rafael Corchuelo.
 *
 * In keeping with the traditional purpose of furthering education and research, it is
 * the policy of the copyright owner to permit non-commercial use and redistribution of
 * this software. It has been tested carefully, but it is not guaranteed for any particular
 * purposes. The copyright owner does not offer any warranties or representations, nor do
 * they accept any liabilities with respect to them.
 */

package acme.framework.testing;

import java.util.List;
import java.util.Random;
import java.util.concurrent.TimeUnit;

import org.junit.jupiter.api.AfterAll;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.MethodOrderer.OrderAnnotation;
import org.junit.jupiter.api.TestInstance;
import org.junit.jupiter.api.TestInstance.Lifecycle;
import org.junit.jupiter.api.TestMethodOrder;
import org.junit.jupiter.api.extension.ExtendWith;
import org.openqa.selenium.By;
import org.openqa.selenium.JavascriptExecutor;
import org.openqa.selenium.PageLoadStrategy;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.firefox.FirefoxDriver;
import org.openqa.selenium.firefox.FirefoxOptions;
import org.openqa.selenium.support.ui.WebDriverWait;

import acme.framework.helpers.PerformanceFileHelper;
import acme.framework.helpers.StringHelper;
import lombok.Getter;
import lombok.Setter;

@TestInstance(Lifecycle.PER_CLASS)
@TestMethodOrder(OrderAnnotation.class)
@ExtendWith(PerformanceExtension.class)
<span class="nc bnc" id="L45" title="All 2 branches missed.">public abstract class AbstractTest {</span>

	// Properties -------------------------------------------------------------

<span class="nc" id="L49">	@Getter</span>
	protected String	protocol;

<span class="nc" id="L52">	@Getter</span>
	protected String	host;

<span class="nc" id="L55">	@Getter</span>
	protected String	port;

<span class="nc" id="L58">	@Getter</span>
	protected String	contextPath;

<span class="nc" id="L61">	@Getter</span>
	protected String	contextHome;

<span class="nc" id="L64">	@Getter</span>
	protected String	contextQuery;

<span class="nc" id="L67">	@Getter</span>
	protected String	baseUrl;

<span class="nc" id="L70">	@Getter</span>
	protected String	homeUrl;


	protected void setBaseCamp(final String protocol, final String host, final String port, final String contextPath, final String contextHome, final String contextQuery) {
<span class="nc bnc" id="L75" title="All 4 branches missed.">		assert !StringHelper.isBlank(protocol);</span>
<span class="nc bnc" id="L76" title="All 4 branches missed.">		assert !StringHelper.isBlank(host);</span>
<span class="nc bnc" id="L77" title="All 4 branches missed.">		assert !StringHelper.isBlank(port);</span>
<span class="nc bnc" id="L78" title="All 8 branches missed.">		assert !StringHelper.isBlank(contextPath) &amp;&amp; contextPath.startsWith(&quot;/&quot;) &amp;&amp; !contextPath.endsWith(&quot;/&quot;);</span>
<span class="nc bnc" id="L79" title="All 8 branches missed.">		assert !StringHelper.isBlank(contextHome) &amp;&amp; contextHome.startsWith(&quot;/&quot;) &amp;&amp; !contextHome.endsWith(&quot;/&quot;);</span>
<span class="nc bnc" id="L80" title="All 6 branches missed.">		assert !StringHelper.isBlank(contextQuery) &amp;&amp; contextQuery.startsWith(&quot;?&quot;);</span>

<span class="nc" id="L82">		this.protocol = protocol;</span>
<span class="nc" id="L83">		this.host = host;</span>
<span class="nc" id="L84">		this.port = port;</span>
<span class="nc" id="L85">		this.contextPath = contextPath;</span>
<span class="nc" id="L86">		this.contextQuery = contextQuery;</span>

<span class="nc" id="L88">		this.baseUrl = String.format(&quot;%s://%s:%s%s&quot;, protocol, host, port, contextPath);</span>
<span class="nc" id="L89">		this.homeUrl = String.format(&quot;%s%s%s&quot;, this.baseUrl, contextHome, contextQuery);</span>
<span class="nc" id="L90">	}</span>


<span class="nc" id="L93">	@Getter</span>
<span class="nc" id="L94">	@Setter</span>
	protected boolean				headless;

<span class="nc" id="L97">	@Getter</span>
<span class="nc" id="L98">	@Setter</span>
	protected boolean				autoPausing;

<span class="nc" id="L101">	@Getter</span>
<span class="nc" id="L102">	@Setter</span>
	protected int					defaultTimeout;

	// Internal state ---------------------------------------------------------

<span class="nc" id="L107">	protected static int			MAX_URL_FETCH_ATTEMPTS	= 10;</span>
	protected FirefoxOptions		options;
	protected WebDriver				driver;
	protected JavascriptExecutor	executor;
	protected Random				random;

	// Constructor ------------------------------------------------------------


	protected AbstractTest() {
<span class="nc" id="L117">		super();</span>
<span class="nc" id="L118">		this.headless = false;</span>
<span class="nc" id="L119">		this.autoPausing = false;</span>
<span class="nc" id="L120">		this.defaultTimeout = 30;</span>
<span class="nc" id="L121">	}</span>

	// JUnit interface --------------------------------------------------------

	@BeforeAll
	protected void beforeAll() {
<span class="nc" id="L127">		this.options = new FirefoxOptions();</span>
<span class="nc" id="L128">		this.options.setHeadless(this.headless);</span>
<span class="nc" id="L129">		this.options.setPageLoadStrategy(PageLoadStrategy.NORMAL);</span>
<span class="nc" id="L130">		this.options.setAcceptInsecureCerts(true);</span>

<span class="nc" id="L132">		this.driver = new FirefoxDriver(this.options);</span>
<span class="nc" id="L133">		this.driver.manage().timeouts().implicitlyWait(this.defaultTimeout, TimeUnit.SECONDS);</span>
<span class="nc" id="L134">		this.driver.manage().window().maximize();</span>

<span class="nc" id="L136">		this.executor = (JavascriptExecutor) this.driver;</span>

<span class="nc" id="L138">		this.random = new Random();</span>
<span class="nc" id="L139">	}</span>

	@BeforeEach
	protected void beforeEach() {
<span class="nc" id="L143">		this.driver.manage().deleteAllCookies();</span>
<span class="nc" id="L144">		this.navigateHome();</span>
<span class="nc" id="L145">	}</span>

	@AfterEach
	protected void afterEach() {
		;
<span class="nc" id="L150">	}</span>

	@AfterAll
	protected void afterAll() {
<span class="nc bnc" id="L154" title="All 2 branches missed.">		if (this.driver != null)</span>
<span class="nc" id="L155">			this.driver.quit();</span>
<span class="nc" id="L156">	}</span>

	// Sleep methods ----------------------------------------------------------

	protected void sleep(final int duration, final boolean exact) {
<span class="nc bnc" id="L161" title="All 6 branches missed.">		assert duration &gt;= 0 &amp;&amp; duration &lt;= 3600;</span>

		long autoPause;

		try {
<span class="nc bnc" id="L166" title="All 2 branches missed.">			if (exact) {</span>
<span class="nc" id="L167">				Thread.sleep(1000L * duration);</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">			} else if (this.autoPausing) {</span>
<span class="nc" id="L169">				autoPause = 1000L * (1 + this.random.nextInt(duration));</span>
<span class="nc" id="L170">				Thread.sleep(autoPause);</span>
			}
<span class="nc" id="L172">		} catch (final Throwable oops) {</span>
<span class="nc" id="L173">			throw new RuntimeException(oops);</span>
		}
<span class="nc" id="L175">	}</span>

	protected void shortSleep() {
<span class="nc" id="L178">		this.sleep(2, false);</span>
<span class="nc" id="L179">	}</span>

	protected void longSleep() {
<span class="nc" id="L182">		this.sleep(5, false);</span>
<span class="nc" id="L183">	}</span>

	// Path-related methods ---------------------------------------------------

	protected String getCurrentUrl() {
		String result;
		int counter;
		String currentUrl;

<span class="nc" id="L192">		this.waitUntilComplete();</span>
<span class="nc" id="L193">		currentUrl = this.driver.getCurrentUrl();</span>
<span class="nc" id="L194">		result = this.extractSimplePath(currentUrl);</span>
<span class="nc bnc" id="L195" title="All 4 branches missed.">		for (counter = 0; counter &lt; AbstractTest.MAX_URL_FETCH_ATTEMPTS &amp;&amp; result.equals(&quot;/master/referrer&quot;); counter++) {</span>
<span class="nc" id="L196">			this.sleep(counter + 1, true);</span>
<span class="nc" id="L197">			currentUrl = this.driver.getCurrentUrl();</span>
<span class="nc" id="L198">			result = this.extractSimplePath(currentUrl);</span>
		}
<span class="nc bnc" id="L200" title="All 4 branches missed.">		assert !result.equals(&quot;/master/referrer&quot;) : &quot;The '/master/referrer' redirector didn't work&quot;;</span>

<span class="nc" id="L202">		return result;</span>
	}

	protected String getSimplePath() {
		String result;
		String currentUrl;

<span class="nc" id="L209">		currentUrl = this.getCurrentUrl();</span>
<span class="nc" id="L210">		result = this.extractSimplePath(currentUrl);</span>

<span class="nc" id="L212">		return result;</span>
	}

	protected void checkSimplePath(final String expectedPath) {
<span class="nc bnc" id="L216" title="All 4 branches missed.">		assert this.isSimplePath(expectedPath);</span>

		String currentUrl, currentPath;

<span class="nc bnc" id="L220" title="All 2 branches missed.">		if (!expectedPath.equals(&quot;#&quot;)) {</span>
<span class="nc" id="L221">			this.waitUntilComplete();</span>
<span class="nc" id="L222">			currentUrl = this.getCurrentUrl();</span>
<span class="nc" id="L223">			currentPath = this.extractSimplePath(currentUrl);</span>
<span class="nc bnc" id="L224" title="All 4 branches missed.">			assert currentPath.equals(expectedPath) : String.format(&quot;The system doesn't navigate from '%s' to '%s'&quot;, currentPath, expectedPath);</span>
		}
<span class="nc" id="L226">	}</span>

	// Location methods -------------------------------------------------------

	protected WebElement locateOne(final By locator) {
<span class="nc bnc" id="L231" title="All 4 branches missed.">		assert locator != null;</span>
<span class="nc bnc" id="L232" title="All 4 branches missed.">		assert this.exists(locator) : String.format(&quot;Cannot find '%s'&quot;, locator.toString());</span>

		WebElement result;

<span class="nc" id="L236">		result = this.driver.findElement(locator);</span>

<span class="nc" id="L238">		return result;</span>
	}

	protected List&lt;WebElement&gt; locateMany(final By locator) {
<span class="nc bnc" id="L242" title="All 4 branches missed.">		assert locator != null;</span>
<span class="nc bnc" id="L243" title="All 4 branches missed.">		assert this.exists(locator) : String.format(&quot;Cannot find '%s'&quot;, locator.toString());</span>

		List&lt;WebElement&gt; result;

<span class="nc" id="L247">		result = this.driver.findElements(locator);</span>

<span class="nc" id="L249">		return result;</span>
	}

	protected boolean exists(final By locator) {
<span class="nc bnc" id="L253" title="All 4 branches missed.">		assert locator != null;</span>

		boolean result;

		try {
<span class="nc" id="L258">			this.driver.findElement(locator);</span>
<span class="nc" id="L259">			result = true;</span>
<span class="nc" id="L260">		} catch (final Throwable oops) {</span>
<span class="nc" id="L261">			result = false;</span>
		}

<span class="nc" id="L264">		return result;</span>
	}

	protected void checkExists(final By locator) {
<span class="nc bnc" id="L268" title="All 4 branches missed.">		assert locator != null;</span>

<span class="nc bnc" id="L270" title="All 4 branches missed.">		assert this.exists(locator) : String.format(&quot;Element '%s' is expected&quot;, locator);</span>
<span class="nc" id="L271">	}</span>

	protected void checkNotExists(final By locator) {
<span class="nc bnc" id="L274" title="All 4 branches missed.">		assert locator != null;</span>

<span class="nc bnc" id="L276" title="All 4 branches missed.">		assert !this.exists(locator) : String.format(&quot;Element '%s' is not expected&quot;, locator);</span>
<span class="nc" id="L277">	}</span>

	// Form-filling methods ---------------------------------------------------

	protected void clear(final By locator) {
<span class="nc bnc" id="L282" title="All 4 branches missed.">		assert locator != null;</span>

		WebElement element;

<span class="nc" id="L286">		element = this.locateOne(locator);</span>
<span class="nc" id="L287">		element.clear();</span>
<span class="nc" id="L288">		this.waitUntilComplete();</span>
<span class="nc" id="L289">		this.shortSleep();</span>
<span class="nc" id="L290">	}</span>

	protected void fill(final By locator, final String value) {
<span class="nc bnc" id="L293" title="All 4 branches missed.">		assert locator != null;</span>
		// value is nullable

		WebElement element;

<span class="nc" id="L298">		element = this.locateOne(locator);</span>
<span class="nc" id="L299">		element.clear();</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">		if (!StringHelper.isBlank(value))</span>
<span class="nc" id="L301">			element.sendKeys(value);</span>
<span class="nc" id="L302">		this.waitUntilComplete();</span>
<span class="nc" id="L303">		this.shortSleep();</span>
<span class="nc" id="L304">	}</span>

	// Navigation methods -----------------------------------------------------

	protected void navigateHome() {
<span class="nc" id="L309">		this.navigate(() -&gt; {</span>
<span class="nc" id="L310">			this.driver.get(this.homeUrl);</span>
<span class="nc" id="L311">			this.longSleep();</span>
<span class="nc" id="L312">		});</span>
<span class="nc" id="L313">	}</span>

	protected void navigate(final String path, final String query) {
<span class="nc bnc" id="L316" title="All 4 branches missed.">		assert this.isSimplePath(path);</span>
<span class="nc bnc" id="L317" title="All 4 branches missed.">		assert this.isSimpleQuery(query);</span>

<span class="nc" id="L319">		this.navigate(() -&gt; {</span>
			String url;

<span class="nc" id="L322">			url = String.format(&quot;%s%s%s%s&quot;, this.baseUrl, path, this.contextQuery, query);</span>
<span class="nc" id="L323">			this.driver.get(url);</span>
<span class="nc" id="L324">			this.longSleep();</span>
<span class="nc" id="L325">		});</span>
<span class="nc" id="L326">	}</span>

	protected void navigate(final Runnable navigator) {
<span class="nc bnc" id="L329" title="All 4 branches missed.">		assert navigator != null;</span>

		By locator;
		WebElement html;
		long startTime, endTime, duration;
		String simplePath;

<span class="nc" id="L336">		locator = By.tagName(&quot;html&quot;);</span>
<span class="nc" id="L337">		html = this.driver.findElement(locator);</span>
<span class="nc bnc" id="L338" title="All 4 branches missed.">		assert html != null;</span>

<span class="nc" id="L340">		startTime = System.currentTimeMillis();</span>
<span class="nc" id="L341">		navigator.run();</span>
<span class="nc" id="L342">		this.waitStalenessOf(html);</span>
<span class="nc" id="L343">		endTime = System.currentTimeMillis();</span>
<span class="nc" id="L344">		duration = endTime - startTime;</span>
<span class="nc" id="L345">		simplePath = this.getSimplePath();</span>
				 
<span class="nc" id="L347">		PerformanceFileHelper.writeRequestRecord(simplePath, duration);</span>

<span class="nc" id="L349">		this.longSleep();</span>
<span class="nc" id="L350">	}</span>

	// Click methods ----------------------------------------------------------

	protected void clickAndGo(final By locator) {
<span class="nc bnc" id="L355" title="All 4 branches missed.">		assert locator != null;</span>

		WebElement element;

<span class="nc" id="L359">		element = this.locateOne(locator);</span>
<span class="nc" id="L360">		this.clickAndGo(element);</span>
<span class="nc" id="L361">	}</span>

	protected void clickAndGo(final WebElement element) {
<span class="nc bnc" id="L364" title="All 4 branches missed.">		assert element != null;</span>

		// INFO: WebElement::click is a nightmare.  Don't use it!
<span class="nc" id="L367">		this.executor.executeScript(&quot;arguments[0].click();&quot;, element);</span>
<span class="nc" id="L368">		this.shortSleep();</span>
<span class="nc" id="L369">		this.waitUntilComplete();</span>
<span class="nc" id="L370">	}</span>

	protected void clickAndWait(final By locator) {
<span class="nc bnc" id="L373" title="All 4 branches missed.">		assert locator != null;</span>

		WebElement element;

<span class="nc" id="L377">		element = this.locateOne(locator);</span>
<span class="nc" id="L378">		this.clickAndWait(element);</span>
<span class="nc" id="L379">	}</span>

	protected void clickAndWait(final WebElement element) {
<span class="nc bnc" id="L382" title="All 4 branches missed.">		assert element != null;</span>

<span class="nc" id="L384">		this.navigate(() -&gt; this.executor.executeScript(&quot;arguments[0].click();&quot;, element));</span>
<span class="nc" id="L385">	}</span>

	// Ancillary methods ------------------------------------------------------

	protected boolean isSimplePath(final String path) {
		boolean result;

<span class="nc bnc" id="L392" title="All 2 branches missed.">		result = !StringHelper.isBlank(path) &amp;&amp; //</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">			(path.equals(&quot;#&quot;) || //</span>
<span class="nc bnc" id="L394" title="All 6 branches missed.">				path.startsWith(&quot;/&quot;) &amp;&amp; !path.endsWith(&quot;/&quot;) &amp;&amp; !path.contains(&quot;?&quot;) //</span>
			);

<span class="nc" id="L397">		return result;</span>
	}

	protected boolean isSimpleQuery(final String query) {
		boolean result;

<span class="nc bnc" id="L403" title="All 6 branches missed.">		result = query == null || (!query.startsWith(&quot;?&quot;) &amp;&amp; !query.startsWith(&quot;&amp;&quot;));</span>

<span class="nc" id="L405">		return result;</span>
	}

	protected String extractSimplePath(final String url) {
<span class="nc bnc" id="L409" title="All 4 branches missed.">		assert !StringHelper.isBlank(url);</span>

		String result;
		int queryPosition;

<span class="nc" id="L414">		result = url.replace(this.baseUrl, &quot;&quot;);</span>
<span class="nc" id="L415">		queryPosition = result.indexOf(&quot;?&quot;);</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">		if (queryPosition != -1)</span>
<span class="nc" id="L417">			result = result.substring(0, queryPosition);</span>

<span class="nc" id="L419">		return result;</span>
	}

	protected void waitStalenessOf(final WebElement html) {
<span class="nc bnc" id="L423" title="All 4 branches missed.">		assert html != null;</span>

		By locator;
		WebDriverWait wait;

		try {
<span class="nc" id="L429">			locator = By.tagName(&quot;html&quot;);</span>
<span class="nc" id="L430">			wait = new WebDriverWait(this.driver, this.defaultTimeout);</span>
<span class="nc" id="L431">			wait.until(WaitConditions.stalenessOf(html, locator));</span>
<span class="nc" id="L432">		} catch (final Throwable oops) {</span>
<span class="nc bnc" id="L433" title="All 2 branches missed.">			assert false : &quot;Timeout waiting for action to complete&quot;;</span>
		}
<span class="nc" id="L435">	}</span>

	protected void waitUntilComplete() {
		WebDriverWait wait;

		try {
<span class="nc" id="L441">			wait = new WebDriverWait(this.driver, this.defaultTimeout);</span>
<span class="nc" id="L442">			wait.until(WaitConditions.documentComplete());</span>
<span class="nc" id="L443">		} catch (final Throwable oops) {</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">			assert false : &quot;Timeout waiting for action to complete&quot;;</span>
		}
<span class="nc" id="L446">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span>Acme-Planner (Run) (2 Jun 2021 12:07:42)</div></body></html>