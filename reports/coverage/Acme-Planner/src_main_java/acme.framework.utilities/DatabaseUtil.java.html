<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../jacoco-resources/report.gif" type="image/gif"/><title>DatabaseUtil.java</title><link rel="stylesheet" href="../../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">Acme-Planner (Run) (2 Jun 2021 12:07:42)</a> &gt; <a href="../../index.html" class="el_group">Acme-Planner</a> &gt; <a href="../index.html" class="el_bundle">src/main/java</a> &gt; <a href="index.source.html" class="el_package">acme.framework.utilities</a> &gt; <span class="el_source">DatabaseUtil.java</span></div><h1>DatabaseUtil.java</h1><pre class="source lang-java linenums">/*
 * DatabaseUtil.java
 *
 * Copyright (C) 2012-2021 Rafael Corchuelo.
 *
 * In keeping with the traditional purpose of furthering education and research, it is
 * the policy of the copyright owner to permit non-commercial use and redistribution of
 * this software. It has been tested carefully, but it is not guaranteed for any particular
 * purposes. The copyright owner does not offer any warranties or representations, nor do
 * they accept any liabilities with respect to them.
 */

package acme.framework.utilities;

import java.io.ByteArrayOutputStream;
import java.io.OutputStream;
import java.io.OutputStreamWriter;
import java.io.Writer;
import java.nio.charset.StandardCharsets;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.Collection;
import java.util.List;
import java.util.Map.Entry;

import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.Query;
import javax.persistence.metamodel.EmbeddableType;
import javax.persistence.metamodel.EntityType;
import javax.persistence.metamodel.Metamodel;

import org.hibernate.Session;
import org.hibernate.boot.Metadata;
import org.hibernate.boot.MetadataSources;
import org.hibernate.engine.spi.EntityEntry;
import org.hibernate.engine.spi.SessionImplementor;
import org.hibernate.service.ServiceRegistry;
import org.hibernate.tool.hbm2ddl.SchemaExport;
import org.hibernate.tool.hbm2ddl.SchemaExport.Action;
import org.hibernate.tool.schema.internal.exec.ScriptTargetOutputToWriter;
import org.hibernate.tool.schema.spi.ScriptTargetOutput;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.core.env.Environment;
import org.springframework.stereotype.Component;
import org.springframework.transaction.PlatformTransactionManager;
import org.springframework.transaction.TransactionDefinition;
import org.springframework.transaction.TransactionStatus;
import org.springframework.transaction.support.DefaultTransactionDefinition;

import acme.framework.entities.DomainEntity;
import acme.framework.helpers.StringHelper;
import acme.framework.helpers.ThrowableHelper;

@Component
<span class="pc bpc" id="L56" title="1 of 2 branches missed.">public class DatabaseUtil {</span>

	// Internal state ---------------------------------------------------------

	@PersistenceContext
	protected EntityManager					entityManager;

	@Autowired
	protected PlatformTransactionManager	transactionManager;

	@Autowired
	protected Environment					environment;

	protected TransactionStatus				transactionStatus;
	protected TransactionDefinition			transactionDefinition;

	// Transaction management --------------------------------------------------


	public void setReadUncommittedIsolationLevel() {
<span class="fc" id="L76">		this.executeCommand(&quot;set transaction isolation level read uncommitted;&quot;);</span>
<span class="fc" id="L77">	}</span>

	public void setReadCommittedIsolationLevel() {
<span class="nc" id="L80">		this.executeCommand(&quot;set transaction isolation level read committed;&quot;);</span>
<span class="nc" id="L81">	}</span>

	public void startTransaction() {
<span class="pc bpc" id="L84" title="2 of 4 branches missed.">		assert !this.isTransactionActive();</span>

<span class="fc" id="L86">		this.transactionDefinition = new DefaultTransactionDefinition();</span>
<span class="fc" id="L87">		this.transactionStatus = this.transactionManager.getTransaction(this.transactionDefinition);</span>
<span class="fc" id="L88">		this.setReadUncommittedIsolationLevel();</span>
<span class="fc" id="L89">		this.clearPersistenceContext();</span>
<span class="fc" id="L90">	}</span>

	public void commitTransaction() {
<span class="pc bpc" id="L93" title="2 of 4 branches missed.">		assert this.isTransactionActive();</span>

		try {
<span class="fc" id="L96">			this.transactionManager.commit(this.transactionStatus);</span>
<span class="pc" id="L97">		} catch (final Throwable oops) {</span>
<span class="nc" id="L98">			ThrowableHelper.print(oops);</span>
		} finally {
<span class="fc" id="L100">			this.transactionStatus = null;</span>
<span class="fc" id="L101">			this.clearPersistenceContext();</span>
		}
<span class="fc" id="L103">	}</span>

	public void rollbackTransaction() {
<span class="nc bnc" id="L106" title="All 4 branches missed.">		assert this.isTransactionActive();</span>

		try {
<span class="nc" id="L109">			this.transactionManager.rollback(this.transactionStatus);</span>
<span class="nc" id="L110">		} catch (final Throwable oops) {</span>
<span class="nc" id="L111">			ThrowableHelper.print(oops);</span>
		} finally {
<span class="nc" id="L113">			this.transactionStatus = null;</span>
<span class="nc" id="L114">			this.clearPersistenceContext();</span>
		}
<span class="nc" id="L116">	}</span>

	public boolean isTransactionActive() {
		boolean result;

<span class="fc bfc" id="L121" title="All 2 branches covered.">		result = this.transactionStatus != null;</span>

<span class="fc" id="L123">		return result;</span>
	}

	// Schema management ------------------------------------------------------

	public void recreateSchema() {
		Metadata metadata;
		String[] dropScript, createScript;		

<span class="fc" id="L132">		metadata = this.buildMetadataSources();		</span>
<span class="fc" id="L133">		dropScript = this.generateScript(metadata, Action.DROP);</span>
<span class="fc" id="L134">		this.executeScript(dropScript);</span>
<span class="fc" id="L135">		createScript = this.generateScript(metadata, Action.CREATE);</span>
<span class="fc" id="L136">		this.executeScript(createScript);</span>
<span class="fc" id="L137">	}</span>

	// Script execution -------------------------------------------------------

	public void executeScript(final String... commands) {
<span class="pc bpc" id="L142" title="2 of 4 branches missed.">		assert commands != null;</span>

		try {
<span class="fc" id="L145">			this.startTransaction();</span>
<span class="fc bfc" id="L146" title="All 2 branches covered.">			for (final String command : commands) {</span>
<span class="pc bpc" id="L147" title="1 of 2 branches missed.">				if (!StringHelper.isBlank(command))</span>
<span class="fc" id="L148">					this.executeCommand(command);</span>
			}
<span class="fc" id="L150">			this.commitTransaction();</span>
<span class="pc" id="L151">		} catch (final Throwable oops) {</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">			if (this.isTransactionActive()) {</span>
<span class="nc" id="L153">				this.rollbackTransaction();</span>
			}
<span class="nc" id="L155">			throw new RuntimeException(oops);</span>
		}
<span class="fc" id="L157">	}</span>

	// Command execution ------------------------------------------------......

	public void executeCommand(final String command) {
<span class="pc bpc" id="L162" title="2 of 4 branches missed.">		assert !StringHelper.isBlank(command);</span>

		Session session;

<span class="fc" id="L166">		session = this.entityManager.unwrap(Session.class);</span>
<span class="fc" id="L167">		session.doWork(connection -&gt; {</span>
			Statement statement;

<span class="fc" id="L170">			statement = connection.createStatement();</span>
<span class="fc" id="L171">			statement.execute(command);</span>
<span class="fc" id="L172">			connection.commit();</span>
<span class="fc" id="L173">		});</span>
<span class="fc" id="L174">	}</span>

	public int executeUpdate(final String command) {
<span class="nc bnc" id="L177" title="All 4 branches missed.">		assert !StringHelper.isBlank(command);</span>

		int result;
		Query query;

<span class="nc" id="L182">		query = this.entityManager.createQuery(command);</span>
<span class="nc" id="L183">		result = query.executeUpdate();</span>

<span class="nc" id="L185">		return result;</span>
	}

	public List&lt;?&gt; executeSelect(final String command) {
<span class="nc bnc" id="L189" title="All 4 branches missed.">		assert !StringHelper.isBlank(command);</span>

		List&lt;?&gt; result;
		Query query;

<span class="nc" id="L194">		query = this.entityManager.createQuery(command);</span>
<span class="nc" id="L195">		result = query.getResultList();</span>

<span class="nc" id="L197">		return result;</span>
	}

	public void persist(final DomainEntity entity) {
<span class="pc bpc" id="L201" title="2 of 4 branches missed.">		assert entity != null;</span>
<span class="pc bpc" id="L202" title="2 of 4 branches missed.">		assert this.isTransactionActive();</span>

<span class="fc" id="L204">		this.entityManager.persist(entity);</span>
<span class="fc" id="L205">	}</span>

	// Miscellaneous ----------------------------------------------------------

	public void printPersistenceContext() {
		SessionImplementor session;
		org.hibernate.engine.spi.PersistenceContext context;
		Entry&lt;Object, EntityEntry&gt;[] entries;

<span class="nc" id="L214">		session = this.entityManager.unwrap(SessionImplementor.class);</span>
<span class="nc" id="L215">		context = session.getPersistenceContext();</span>
<span class="nc" id="L216">		entries = context.reentrantSafeEntityEntries();</span>

<span class="nc bnc" id="L218" title="All 2 branches missed.">		for (final Entry&lt;Object, EntityEntry&gt; entry : entries) {</span>
<span class="nc" id="L219">			System.out.printf(&quot;%s%n&quot;, entry.getValue());</span>
		}
<span class="nc" id="L221">	}</span>

	public void clearPersistenceContext() {
<span class="fc" id="L224">		this.entityManager.clear();</span>
<span class="fc" id="L225">	}</span>

	// Internal methods -------------------------------------------------------

	@SuppressWarnings(&quot;deprecation&quot;)
	protected Metadata buildMetadataSources() {
		Metadata result;
		Session session;
		ServiceRegistry registry;
		MetadataSources sources;		
		Metamodel metamodel;
		Collection&lt;EntityType&lt;?&gt;&gt; entities;
		Collection&lt;EmbeddableType&lt;?&gt;&gt; embeddables;
		
<span class="fc" id="L239">		session = this.entityManager.unwrap(Session.class);</span>
<span class="pc bpc" id="L240" title="2 of 4 branches missed.">		assert session != null;</span>
<span class="fc" id="L241">		registry = session.getSessionFactory().getSessionFactory().getServiceRegistry().getParentServiceRegistry();</span>
<span class="fc" id="L242">		sources = new MetadataSources(registry);</span>
<span class="fc" id="L243">		metamodel = this.entityManager.getMetamodel();</span>
<span class="fc" id="L244">		entities = metamodel.getEntities();</span>
<span class="fc bfc" id="L245" title="All 2 branches covered.">		for (final EntityType&lt;?&gt; entity : entities) {</span>
<span class="fc" id="L246">			sources.addAnnotatedClass(entity.getJavaType());</span>
		}
<span class="fc" id="L248">		embeddables = metamodel.getEmbeddables();</span>
<span class="fc bfc" id="L249" title="All 2 branches covered.">		for (final EmbeddableType&lt;?&gt; embeddable : embeddables) {</span>
<span class="fc" id="L250">			sources.addAnnotatedClass(embeddable.getJavaType());</span>
		}
<span class="fc" id="L252">		result = sources.buildMetadata();</span>

<span class="fc" id="L254">		return result;</span>
	}

	protected String[] generateScript(final Metadata metadata, final Action action) {
<span class="pc bpc" id="L258" title="2 of 4 branches missed.">		assert metadata != null;</span>
<span class="pc bpc" id="L259" title="3 of 8 branches missed.">		assert action != null &amp;&amp; (action.equals(Action.CREATE) || action.equals(Action.DROP));</span>

		String[] result;
		String text;
		SchemaExport exporter;
		ScriptTargetOutput target;

<span class="fc" id="L266">		text = null;</span>
<span class="fc" id="L267">		try (OutputStream outputStream = new ByteArrayOutputStream(); Writer writer = new OutputStreamWriter(outputStream, StandardCharsets.UTF_8)) {</span>
<span class="fc" id="L268">			target = new ScriptTargetOutputToWriter(writer);</span>

<span class="fc" id="L270">			exporter = new SchemaExport();</span>
<span class="fc" id="L271">			exporter.setHaltOnError(true);</span>
<span class="fc" id="L272">			exporter.setFormat(false);</span>
<span class="fc" id="L273">			exporter.setDelimiter(&quot;;&quot;);</span>

<span class="fc" id="L275">			exporter.perform(action, metadata, target);</span>
<span class="fc" id="L276">			text = outputStream.toString();</span>
<span class="nc" id="L277">		} catch (final Throwable oops) {</span>
<span class="nc" id="L278">			throw new RuntimeException(oops);</span>
		}

<span class="pc bpc" id="L281" title="2 of 4 branches missed.">		assert text != null;</span>
<span class="fc" id="L282">		text = &quot;set foreign_key_checks=0;\n&quot; + text + &quot;set foreign_key_checks=1;\n&quot;;</span>

<span class="fc" id="L284">		result = text.split(&quot;;\\s*[\r\n]+&quot;);</span>
<span class="fc bfc" id="L285" title="All 2 branches covered.">		if (action.equals(Action.DROP)) {</span>
			// HINT: the exporter generates ALTER statements without checking if the tables exists!
			// HINT+ Thus, we need to remove those statements explicitly.
			List&lt;String&gt; patch;

<span class="fc" id="L290">			patch = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L291" title="All 2 branches covered.">			for (final String command : result) {</span>
<span class="fc bfc" id="L292" title="All 2 branches covered.">				if (!command.trim().startsWith(&quot;alter table&quot;))</span>
<span class="fc" id="L293">					patch.add(command);</span>
			}
<span class="fc" id="L295">			result = patch.toArray(new String[0]);</span>
		}

<span class="fc" id="L298">		return result;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span>Acme-Planner (Run) (2 Jun 2021 12:07:42)</div></body></html>