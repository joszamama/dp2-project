<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../jacoco-resources/report.gif" type="image/gif"/><title>PerformanceFileHelper.java</title><link rel="stylesheet" href="../../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">Acme-Planner (Run) (2 Jun 2021 12:07:42)</a> &gt; <a href="../../index.html" class="el_group">Acme-Planner</a> &gt; <a href="../index.html" class="el_bundle">src/main/java</a> &gt; <a href="index.source.html" class="el_package">acme.framework.helpers</a> &gt; <span class="el_source">PerformanceFileHelper.java</span></div><h1>PerformanceFileHelper.java</h1><pre class="source lang-java linenums">/*
 * PerformanceFileHelper.java
 *
 * Copyright (C) 2012-2021 Rafael Corchuelo.
 *
 * In keeping with the traditional purpose of furthering education and research, it is
 * the policy of the copyright owner to permit non-commercial use and redistribution of
 * this software. It has been tested carefully, but it is not guaranteed for any particular
 * purposes. The copyright owner does not offer any warranties or representations, nor do
 * they accept any liabilities with respect to them.
 */

package acme.framework.helpers;

import java.io.File;
import java.io.FileOutputStream;
import java.lang.reflect.Method;
import java.nio.charset.StandardCharsets;
import java.sql.Timestamp;
import java.util.HashSet;
import java.util.Set;

import org.junit.jupiter.api.extension.ExtensionContext;

<span class="nc bnc" id="L25" title="All 2 branches missed.">public class PerformanceFileHelper {</span>

	// Constructors -----------------------------------------------------------

	private PerformanceFileHelper() {
		;
	}


	public static final String	FOLDER	= &quot;./reports&quot;;

	public static String		TEST_FILEPATH;
	public static String		REQUEST_FILEPATH;

	static {
		long currentTime;
		Timestamp timestamp;
		String suffix;
		File folder;

<span class="nc" id="L45">		folder = new File(PerformanceFileHelper.FOLDER);</span>
<span class="nc bnc" id="L46" title="All 6 branches missed.">		assert !folder.exists() || folder.canWrite() : &quot;Cannot write to './reports' folder&quot;;</span>
<span class="nc bnc" id="L47" title="All 2 branches missed.">		if (!folder.exists())</span>
<span class="nc" id="L48">			folder.mkdirs();</span>

<span class="nc" id="L50">		currentTime = System.currentTimeMillis();</span>
<span class="nc" id="L51">		timestamp = new Timestamp(currentTime);</span>
<span class="nc" id="L52">		suffix = timestamp.toString().replace(&quot; &quot;, &quot;T&quot;).replace(&quot;:&quot;, &quot;-&quot;);</span>
<span class="nc" id="L53">		PerformanceFileHelper.TEST_FILEPATH = String.format(&quot;%s/performance-tests;%s.csv&quot;, PerformanceFileHelper.FOLDER, suffix);</span>

<span class="nc" id="L55">		PerformanceFileHelper.REQUEST_FILEPATH = String.format(&quot;%s/performance-requests;%s.csv&quot;, PerformanceFileHelper.FOLDER, suffix);</span>
	}

	// Internal state ---------------------------------------------------------

	private static boolean		initialised;
	private static Set&lt;String&gt;	irrelevantSimplePaths;

	static {
<span class="nc" id="L64">		PerformanceFileHelper.initialised = false;</span>
<span class="nc" id="L65">		PerformanceFileHelper.irrelevantSimplePaths = new HashSet&lt;String&gt;();</span>
<span class="nc" id="L66">		PerformanceFileHelper.irrelevantSimplePaths.add(&quot;/master/referrer&quot;);</span>
<span class="nc" id="L67">		PerformanceFileHelper.irrelevantSimplePaths.add(&quot;/master/oops&quot;);</span>
<span class="nc" id="L68">		PerformanceFileHelper.irrelevantSimplePaths.add(&quot;/master/populate-initial&quot;);</span>
<span class="nc" id="L69">		PerformanceFileHelper.irrelevantSimplePaths.add(&quot;/master/populate-sample&quot;);</span>
<span class="nc" id="L70">	}</span>

	// Business methods -------------------------------------------------------	


	public static void initialise() {
<span class="nc" id="L76">		synchronized (PerformanceFileHelper.class) {</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">			if (!PerformanceFileHelper.initialised) {</span>
<span class="nc" id="L78">				PerformanceFileHelper.clearPerformanceFile(PerformanceFileHelper.TEST_FILEPATH, &quot;timestamp,test-class,test-method,time,description,result&quot;);</span>
<span class="nc" id="L79">				PerformanceFileHelper.clearPerformanceFile(PerformanceFileHelper.REQUEST_FILEPATH, &quot;timestamp,simple-path,time&quot;);</span>
<span class="nc" id="L80">				PerformanceFileHelper.initialised = true;</span>
			}
		}
<span class="nc" id="L83">	}</span>

	public static void writeTestRecord(final ExtensionContext context, final long duration) {
<span class="nc bnc" id="L86" title="All 4 branches missed.">		assert context != null;</span>
<span class="nc bnc" id="L87" title="All 4 branches missed.">		assert duration &gt;= 0;</span>

		String record;

<span class="nc" id="L91">		record = PerformanceFileHelper.buildPerformanceRecord(context, duration);</span>
<span class="nc" id="L92">		PerformanceFileHelper.appendToFile(PerformanceFileHelper.TEST_FILEPATH, record);</span>
<span class="nc" id="L93">	}</span>

	public static void writeRequestRecord(final String simplePath, final long duration) {
<span class="nc bnc" id="L96" title="All 4 branches missed.">		assert !StringHelper.isBlank(simplePath);</span>
<span class="nc bnc" id="L97" title="All 4 branches missed.">		assert duration &gt;= 0;</span>

		String record;

<span class="nc bnc" id="L101" title="All 2 branches missed.">		if (!PerformanceFileHelper.irrelevantSimplePaths.contains(simplePath)) {</span>
<span class="nc" id="L102">			record = PerformanceFileHelper.buildPerformanceRecord(simplePath, duration);</span>
<span class="nc" id="L103">			PerformanceFileHelper.appendToFile(PerformanceFileHelper.REQUEST_FILEPATH, record);</span>
		}
<span class="nc" id="L105">	}</span>

	// Ancillary methods ------------------------------------------------------

	protected static String buildPerformanceRecord(final ExtensionContext context, final long duration) {
<span class="nc bnc" id="L110" title="All 4 branches missed.">		assert context != null;</span>
<span class="nc bnc" id="L111" title="All 4 branches missed.">		assert duration &gt;= 0;</span>

		StringBuilder result;
		long currentTime;
		Timestamp timestamp;
		String clazzName;
		String methodName;
		String description;
		String exception;

<span class="nc" id="L121">		currentTime = System.currentTimeMillis();</span>
<span class="nc" id="L122">		timestamp = new Timestamp(currentTime);</span>
<span class="nc" id="L123">		clazzName = context.getRequiredTestClass().getName();</span>
<span class="nc" id="L124">		methodName = context.getRequiredTestMethod().getName();</span>
<span class="nc" id="L125">		description = String.format(&quot;\&quot;%s\&quot;&quot;, context.getDisplayName().replace(&quot;\&quot;&quot;, &quot;'&quot;));</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">		exception = (context.getExecutionException().isPresent() ? context.getExecutionException().get().getLocalizedMessage() : &quot;OK&quot;);</span>

<span class="nc" id="L128">		result = new StringBuilder();</span>
<span class="nc" id="L129">		result.append(timestamp);</span>
<span class="nc" id="L130">		result.append(&quot;,&quot;);</span>
<span class="nc" id="L131">		result.append(clazzName);</span>
<span class="nc" id="L132">		result.append(&quot;,&quot;);</span>
<span class="nc" id="L133">		result.append(methodName);</span>
<span class="nc" id="L134">		result.append(&quot;,&quot;);</span>
<span class="nc" id="L135">		result.append(duration);</span>
<span class="nc" id="L136">		result.append(&quot;,&quot;);</span>
<span class="nc" id="L137">		result.append(description);</span>
<span class="nc" id="L138">		result.append(&quot;,&quot;);</span>
<span class="nc" id="L139">		result.append(exception);</span>

<span class="nc" id="L141">		return result.toString();</span>
	}

	protected static String buildPerformanceRecord(final String simplePath, final long duration) {
<span class="nc bnc" id="L145" title="All 4 branches missed.">		assert !StringHelper.isBlank(simplePath);</span>
<span class="nc bnc" id="L146" title="All 4 branches missed.">		assert duration &gt;= 0;</span>

		StringBuilder result;
		long currentTime;
		Timestamp timestamp;

<span class="nc" id="L152">		currentTime = System.currentTimeMillis();</span>
<span class="nc" id="L153">		timestamp = new Timestamp(currentTime);</span>

<span class="nc" id="L155">		result = new StringBuilder();</span>
<span class="nc" id="L156">		result.append(timestamp);</span>
<span class="nc" id="L157">		result.append(&quot;,&quot;);</span>
<span class="nc" id="L158">		result.append(simplePath);</span>
<span class="nc" id="L159">		result.append(&quot;,&quot;);</span>
<span class="nc" id="L160">		result.append(duration);</span>

<span class="nc" id="L162">		return result.toString();</span>
	}

	protected static void clearPerformanceFile(final String filePath, final String header) {
<span class="nc bnc" id="L166" title="All 4 branches missed.">		assert !StringHelper.isBlank(filePath);</span>
<span class="nc bnc" id="L167" title="All 4 branches missed.">		assert !StringHelper.isBlank(header);</span>

		File file;
		boolean deleted, created;

<span class="nc" id="L172">		file = new File(filePath);</span>
<span class="nc bnc" id="L173" title="All 6 branches missed.">		assert !file.exists() || file.canWrite() : String.format(&quot;Cannot clear performance file '%s'&quot;, filePath);</span>
		try {
<span class="nc bnc" id="L175" title="All 2 branches missed.">			if (file.exists()) {</span>
<span class="nc" id="L176">				deleted = file.delete();</span>
<span class="nc bnc" id="L177" title="All 4 branches missed.">				assert deleted : String.format(&quot;Cannot delete current performance file '%s'&quot;, filePath);</span>
			}
<span class="nc" id="L179">			created = file.createNewFile();</span>
<span class="nc bnc" id="L180" title="All 4 branches missed.">			assert created : String.format(&quot;Cannot create new performance file '%s'&quot;, filePath);</span>
<span class="nc" id="L181">			PerformanceFileHelper.appendToFile(filePath, header);</span>
<span class="nc" id="L182">		} catch (final Throwable oops) {</span>
<span class="nc" id="L183">			throw new RuntimeException(oops);</span>
		}
<span class="nc" id="L185">	}</span>

	protected static void appendToFile(final String filePath, final String record) {
<span class="nc bnc" id="L188" title="All 4 branches missed.">		assert !StringHelper.isBlank(filePath);</span>
<span class="nc bnc" id="L189" title="All 4 branches missed.">		assert !StringHelper.isBlank(record);</span>

		File file;
		byte[] buffer, crlf;

<span class="nc" id="L194">		synchronized (PerformanceFileHelper.class) {</span>
<span class="nc" id="L195">			file = new File(filePath);</span>
<span class="nc" id="L196">			try (FileOutputStream output = new FileOutputStream(file, true)) {</span>
<span class="nc bnc" id="L197" title="All 6 branches missed.">				assert file.exists() &amp;&amp; file.canWrite() : String.format(&quot;Cannot write to performance file '%s'&quot;, filePath);</span>
<span class="nc" id="L198">				buffer = record.getBytes(StandardCharsets.UTF_8);</span>
<span class="nc" id="L199">				output.write(buffer);</span>
<span class="nc" id="L200">				crlf = System.lineSeparator().getBytes(StandardCharsets.UTF_8);</span>
<span class="nc" id="L201">				output.write(crlf);</span>
<span class="nc" id="L202">			} catch (final Throwable oops) {</span>
<span class="nc" id="L203">				throw new RuntimeException(oops);</span>
			}
		}
<span class="nc" id="L206">	}</span>

	protected static String getFullTestName(final ExtensionContext context) {
<span class="nc bnc" id="L209" title="All 4 branches missed.">		assert context != null;</span>

		String result;
		Class&lt;?&gt; clazz;
		Method method;

<span class="nc" id="L215">		clazz = context.getRequiredTestClass();</span>
<span class="nc" id="L216">		method = context.getRequiredTestMethod();</span>

<span class="nc" id="L218">		result = String.format(&quot;%s::%s&quot;, clazz.getName(), method.getName());</span>

<span class="nc" id="L220">		return result;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span>Acme-Planner (Run) (2 Jun 2021 12:07:42)</div></body></html>